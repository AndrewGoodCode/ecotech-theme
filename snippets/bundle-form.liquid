{% assign extend_bundles = product.metafields.custom.extend_bundle.value %}

{% for extend_bundle in extend_bundles %}
  {% assign products = extend_bundle.products.value %}
  {% assign variants = extend_bundle.variants.value %}
  {% assign is_substrate = 0 %}
  {% assign substrate_handle = '' %}
  {% assign is_location = 0 %}
  {% assign location_handle = '' %}
  {% assign is_colour = 0 %}
  {% assign first_colour_handle = '' %}
  {% assign colour_handles_str = '' %}
  {% assign is_finish = 0 %}
  {% assign finish_handle = '' %}
  {% assign variants_str = '' %}
  {% comment %} check is_colour, is_finish {% endcomment %}
  {% for product_item in products %}
    {% if product_item.title == 'Substrate' %}
      {% assign is_substrate = 2 %}
      {% assign substrate_handle = product_item.handle %}
    {% endif %}
    {% if product_item.title == 'Location' %}
      {% assign is_location = 2 %}
      {% assign location_handle = product_item.handle %}
    {% endif %}
    {% if product_item.variants != blank %}
      {% for option_item in product_item.options %}
        {% if option_item == 'Colour' %}
          {% assign colour_handles_str = colour_handles_str | append: ',' | append: product_item.handle %}
          {% if product_item.title contains 'Colour' %}
            {% assign first_colour_handle = product_item.handle %}
          {% endif %}
          {% if length == 1 %}
            {% assign is_colour = 1 %}
          {% else %}
            {% assign is_colour = 2 %}
          {% endif %}
        {% endif %}
        {% if option_item == 'Finish' %}
          {% assign finish_handle = product_item.handle %}
          {% if length == 1 %}
            {% assign is_finish = 1 %}
          {% else %}
            {% assign is_finish = 2 %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {% for variant_item in product_item.variants %}
        {% assign variants_str = variants_str | append: ',' | append: variant_item.id %}
      {% endfor %}
    {% endif %}
  {% endfor %}
  {% for variant_item in variants %}
    {% if variant_item.product.title == 'Substrate' %}
      {% assign is_substrate = 2 %}
      {% assign substrate_handle = variant_item.product.handle %}
    {% endif %}
    {% if variant_item.product.title == 'Location' %}
      {% assign is_location = 2 %}
      {% assign location_handle = variant_item.product.handle %}
    {% endif %}
    {% for option_item in variant_item.product.options %}
      {% if option_item == 'Colour' %}
        {% unless colour_handles_str contains variant_item.product.handle %}
          {% assign colour_handles_str = colour_handles_str | append: ',' | append: variant_item.product.handle %}
        {% endunless %}
        {% if variant_item.product.title contains 'Colour' %}
          {% assign first_colour_handle = variant_item.product.handle %}
        {% endif %}
        {% if is_colour == 0 %}
          {% assign is_colour = 1 %}
        {% else %}
          {% assign is_colour = 2 %}
        {% endif %}
      {% endif %}
      {% if option_item == 'Finish' %}
        {% assign finish_handle = variant_item.product.handle %}
        {% if is_finish == 0 %}
          {% assign is_finish = 1 %}
        {% else %}
          {% assign is_finish = 2 %}
        {% endif %}
      {% endif %}
    {% endfor %}
    {% assign variants_str = variants_str | append: ',' | append: variant_item.id %}
  {% endfor %}
  {% comment %} get products id, length {% endcomment %}
  {% assign product_handle_str = '' %}
  {% assign product_qty_str = '' %}
  {% for product_item in products %}
    {% if product_item.handle != finish_handle
      and product_item.handle != substrate_handle
      and product_item.handle != location_handle
    %}
      {% unless colour_handles_str contains product_item.handle %}
        {% assign product_handle_str = product_handle_str | append: ',' | append: product_item.handle %}
        {% assign length = product_item.variants | size %}
        {% assign product_qty_str = product_qty_str | append: ',' | append: length %}
      {% endunless %}
    {% endif %}
  {% endfor %}
  {% assign prev_name = '' %}
  {% assign main_name = '' %}
  {% assign qty = 0 %}
  {% for variant_item in variants %}
    {% if variant_item.product.handle != finish_handle
      and variant_item.product.handle != substrate_handle
      and variant_item.product.handle != location_handle
    %}
      {% unless colour_handles_str contains variant_item.product.handle %}
        {% assign main_name = variant_item.product.title %}
        {% if main_name != prev_name %}
          {% assign product_handle_str = product_handle_str | append: ',' | append: variant_item.product.handle %}
          {% if qty > 0 %}
            {% assign product_qty_str = product_qty_str | append: ',' | append: qty %}
          {% endif %}
          {% assign prev_name = main_name %}
          {% assign qty = 1 %}
        {% else %}
          {% assign qty = 2 %}
        {% endif %}
      {% endunless %}
    {% endif %}
  {% endfor %}
  {% assign product_qty_str = product_qty_str | append: ',' | append: qty %}
{% endfor %}

{% assign length = product_handle_str | size %}
{% assign product_handle_str = product_handle_str | slice: 1, length %}
{% assign length = product_qty_str | size %}
{% assign product_qty_str = product_qty_str | slice: 1, length %}

{% assign product_handle_list = product_handle_str | split: ',' %}
{% assign product_qty_list = product_qty_str | split: ',' %}

{% assign first_page_products = product_handle_list | size %}
{% assign page_num = 1 %}
{% comment %}
  {% if first_page_products > 2 %}
    {% assign a = first_page_products | divided_by: 2 %}
    {% assign first_page_products = first_page_products | minus: a %}
    {% assign page_num = 2 %}
  {% endif %}
{% endcomment %}

{% assign is_colour_or_finish = 0 %}
{% if is_colour > 0 or is_finish > 0 %}
  {% assign is_colour_or_finish = 1 %}
{% endif %}

{% comment %} arrange the colour products  {% endcomment %}
{% assign colour_handles = colour_handles_str | remove_first: ',' | split: ',' %}

<div class="smart-form form_container">
  <div class="card position-relative rounded-2 overflow-hidden">
    <div class="form w-100 h-100 row">
      <div class="left-side col-md-4 px-4 py-5">
        <div class="steps-content mt-1">
          <div class="lh-1">
            <h3 class="h-label small">Configure</h3>
            <span class="bundle-name display-6">{{ product.title }}</span>
          </div>
          <div class="price lh-1 mt-2 fs-3">{{ product.price | money }}</div>
          <div class="description mt-3 fs-6">
            <em class="small">Start by entering your project information. Bundle price will update accordingly.</em>
          </div>
        </div>
        <ul class="form-progress-bar px-0">
          <li class="active"><p>Project Information</p></li>
          {% if is_colour_or_finish > 0 %}
            <li><p>Colour &amp; Finish</p></li>
          {% endif %}
          {% assign option = 3 %}
          {% if first_page_products > 0 %}
            <li>
              <p>Included Products</p>
            </li>
            {% if page_num > 1 %}
              {% assign option = option | plus: 1 %}
              <li>
                <p>Additional Products</p>
              </li>
            {% endif %}
            {% assign option = option | plus: 1 %}
          {% endif %}
          <li>
            <p>Bundle Review</p>
          </li>
        </ul>
        <ul class="form-progress-bar-mobile  mt-4">
          <li class="active"><p>1</p></li>
          {% if is_colour_or_finish > 0 %}
            <li><p>2</p></li>
          {% endif %}
          {% assign option = 3 %}
          {% if first_page_products > 0 %}
            <li>
              <p>{{ option }}</p>
            </li>
            {% if page_num > 1 %}
              {% assign option = option | plus: 1 %}
              <li>
                <p>{{ option }}</p>
              </li>
            {% endif %}
            {% assign option = option | plus: 1 %}
          {% endif %}
          <li>
            <p>{{ option }}</p>
          </li>
        </ul>
      </div>
      <div class="right-side col-md-8">
        <div class="main active">
          <div>
            <div class="mt-1 pb-3"><h3 class="h-label small">Project Information</h3></div>
            <div class="fw-bold">Project Size</div>
            <p>
              Enter bundle quantity, or specify the size of your coverage area to have the required product quantities
              automatically calculated.
            </p>
            <div class="mt-3 mb-3">
              <div class="row">
                <label for="project_area" class="form-label col-sm-6">Project Area</label>
                <div class="col-md-6">
                  <input
                    type="number"
                    class="form-control "
                    value="100"
                    id="project_area"
                    placeholder="2000"
                  >
                </div>
              </div>
              <div class="row  mt-1">
                <label for="product_quantity" class="form-label col-sm-6">Product Quantity</label>
                <div class="col-sm-6">
                  <input
                    type="number"
                    class="form-control "
                    value="1"
                    id="product_quantity"
                    placeholder="1"
                  >
                </div>
              </div>
            </div>
            {% if is_substrate > 0 %}
              <div class="fw-bold">Project Substrate</div>
              <p>Select your surface substrate material. This will decide some of the bundle's contents.</p>
              <div class="row">
                <select class="form-select" aria-label="Select surface substrate">
                  <option selected>Select surface substrate</option>
                  {% assign substrate_product = all_products[substrate_handle] %}
                  {% for substrate in substrate_product.variants %}
                    {% if variants_str contains substrate.id %}
                      <option
                        value="{{substrate.id}}"
                        {% if forloop.index == 1 %}
                          selected
                        {% endif %}
                      >
                        {{ substrate.title }}
                      </option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            {% endif %}
            {% if is_location > 0 %}
              <div class="fw-bold mt-2">Location</div>
              <div class="row">
                <select class="form-select" aria-label="Select surface substrate">
                  <option selected>Select Location</option>
                  {% assign location_product = all_products[location_handle] %}
                  {% for location_item in location_product.variants %}
                    {% if variants_str contains location_item.id %}
                      <option
                        value="{{location_item.id}}"
                        {% if forloop.index == 1 %}
                          selected
                        {% endif %}
                      >
                        {{ location_item.title }}
                      </option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            {% endif %}
          </div>
          <div class="buttons button_space mt-4">
            <button class="next_button">
              {% if is_colour_or_finish > 0 %}
                <div>Colour & Finish</div>
              {% else %}
                <div>Included Products</div>
              {% endif %}
              <div>&nbsp;&gt;</div>
            </button>
          </div>
        </div>
        {% if is_colour_or_finish > 0 %}
          <div class="main">
            <div>
              <div class="mt-1 pb-3"><h3 class="h-label small">Colour &amp; Finish</h3></div>
              <div class="">
                {% if is_colour > 0 %}
                  {% if first_colour_handle != blank %}
                    {% assign colour_product = all_products[first_colour_handle] %}
                    <div class="option-heading">
                      {% if colour_product.price > 0 %}
                        <input
                          class="form-check-input p-2"
                          type="checkbox"
                          checked
                          value="{{colour_product.id}}"
                          name="{{colour_product.handle}}"
                          id="product-{{colour_product.id}}"
                        >
                      {% endif %}
                      <label class="form-check-label" for="product-{{colour_product.id}}">
                        Colour: <em>{{ colour_product.title }}</em>
                      </label>
                    </div>
                    <div class="row mb-2 product-{{colour_product.id}}">
                      {% assign index = 0 %}
                      {% for variant_item in colour_product.variants %}
                        {% if variants_str contains variant_item.id %}
                          <div class="col-6 col-md-2 col-sm-4 mt-2 mr-2">
                            <div class="custom-control custom-radio position-relative">
                              <input
                                type="radio"
                                class="custom-control-input form-check-input"
                                id="variant-{{variant_item.id}}"
                                name="colour-variant"
                                value="{{variant_item.id}}"
                                {% if index == 0 %}
                                  checked
                                {% endif %}
                              >
                              <label class="custom-control-label w-100" for="variant-{{variant_item.id}}">
                                <img src="{{variant_item.featured_image | img_url }}" alt="#" class="img-fluid w-100">
                              </label>
                            </div>
                            <div class="text-center fs-6 lh-1 mt-1">
                              <small>{{ variant_item.title }}</small>
                            </div>
                          </div>
                          {% assign index = index | plus: 1 %}
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}
                  {% for colour_handle in colour_handles %}
                    {% if colour_handle != first_colour_handle %}
                      {% assign colour_product = all_products[colour_handle] %}
                      <div class="option-heading">
                        {% if colour_product.price > 0 %}
                          <input
                            class="form-check-input p-2"
                            type="checkbox"
                            checked
                            value="{{colour_product.id}}"
                            name="{{colour_product.handle}}"
                            id="product-{{colour_product.id}}"
                          >
                        {% endif %}
                        <label class="form-check-label" for="product-{{colour_product.id}}">
                          Colour: <em>{{ colour_product.title }}</em>
                        </label>
                      </div>
                      {% assign for_index = forloop.index %}
                      <div class="row mb-2 product-{{colour_product.id}}">
                        {% assign index = 0 %}
                        {% for variant_item in colour_product.variants %}
                          {% if variants_str contains variant_item.id %}
                            <div class="col-6 col-md-2 col-sm-4 mt-2 mr-2">
                              <div class="custom-control custom-radio position-relative">
                                <input
                                  type="radio"
                                  class="custom-control-input form-check-input"
                                  id="variant-{{variant_item.id}}"
                                  name="colour-variant{{for_index}}"
                                  value="{{variant_item.id}}"
                                  {% if index == 0 %}
                                    checked
                                  {% endif %}
                                >
                                <label class="custom-control-label w-100" for="variant-{{variant_item.id}}">
                                  <img src="{{variant_item.featured_image | img_url }}" alt="#" class="img-fluid w-100">
                                </label>
                              </div>
                              <div class="text-center fs-6 lh-1 mt-1">
                                <small>{{ variant_item.title }}</small>
                              </div>
                            </div>
                            {% assign index = index | plus: 1 %}
                          {% endif %}
                        {% endfor %}
                      </div>
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% if is_finish > 0 %}
                  {% assign finish_product = all_products[finish_handle] %}
                  <div class="option-heading mt-4">
                    {% if finish_product.price > 0 %}
                      <input
                        class="form-check-input p-2"
                        type="checkbox"
                        checked
                        value="{{finish_product.id}}"
                        name="{{finish_product.handle}}"
                        id="product-{{finish_product.id}}"
                      >
                    {% endif %}
                    <label class="form-check-label" for="product-{{finish_product.id}}">
                      Finish: <strong>{{ finish_product.title }}</strong>
                    </label>
                  </div>
                  <div class="row mb-2 product-{{finish_product.id}}">
                    {% assign index = 0 %}
                    {% for variant_item in finish_product.variants %}
                      {% if variants_str contains variant_item.id %}
                        {% assign img_url = finish_product.featured_image %}
                        {% if variant_item.featured_image != blank %}
                          {% assign img_url = variant_item.featured_image %}
                        {% endif %}
                        <div class="col-6 col-md-2 col-sm-4 mt-2 mr-2">
                          <div class="custom-control custom-radio position-relative">
                            <input
                              type="radio"
                              class="custom-control-input form-check-input"
                              id="variant-{{variant_item.id}}"
                              name="finish-variant"
                              value="{{variant_item.id}}"
                              {% if index == 0 %}
                                checked
                              {% endif %}
                            >
                            <label class="custom-control-label w-100" for="variant-{{variant_item.id}}">
                              <img src="{{img_url | img_url }}" alt="#" class="img-fluid w-100">
                            </label>
                          </div>
                          <div class="text-center fs-6 lh-1 mt-1">
                            <small>{{ variant_item.title }}</small>
                          </div>
                        </div>
                        {% assign index = index | plus: 1 %}
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="buttons button_space mt-4">
              <button class="back_button">
                <div>&lt;&nbsp;</div>
                <div>Project Information</div>
              </button>
              <button class="next_button">
                <div>Included Products</div>
                <div>&nbsp;&gt;</div>
              </button>
            </div>
          </div>
        {% endif %}
        {% comment %}  other products first, second page {% endcomment %}
        {% if first_page_products > 0 %}
          <div class="main">
            <div class="">
              <div class="mt-1 pb-3"><h3 class="h-label small">Included Products</h3></div>
              {% for product_handle in product_handle_list %}
                {% assign loop_index = forloop.index | minus: 1 %}
                {% if loop_index < first_page_products %}
                  {% assign product_item = all_products[product_handle] %}
                  <div class="row mb-2">
                    {% assign qty = product_qty_list[loop_index] | plus: 0 %}
                    {% if qty > 1 %}
                      <div class="">
                        <div class="form-check">
                          <input
                            class="form-check-input p-2"
                            type="checkbox"
                            checked
                            value="{{product_item.id}}"
                            name="{{product_item.handle}}"
                            id="product-{{product_item.id}}"
                          >
                          <label class="form-check-label" for="product-{{product_item.id}}">
                            <div class="fw-bold">{{ product_item.title }}</div>
                            {% assign handle = product_item.handle %}
                            <div class="fst-italic fs-6 text-secondary lh-1">
                              {{ all_products[handle].metafields.global.description_tag }}
                            </div>
                            <select
                              class="form-select mt-1 product-{{product_item.id}}"
                              aria-label="Default select example"
                            >
                              <option selected>Select</option>
                              {% for variant_item in product_item.variants %}
                                {% if variants_str contains variant_item.id %}
                                  <option value="{{variant_item.id}}">{{ variant_item.title }}</option>
                                {% endif %}
                              {% endfor %}
                            </select>
                          </label>
                        </div>
                      </div>
                    {% else %}
                      {% for variant_item in product_item.variants %}
                        {% if variants_str contains variant_item.id %}
                          <div class="">
                            <div class="form-check">
                              <input
                                class="form-check-input p-2"
                                type="checkbox"
                                checked
                                value="{{variant_item.id}}"
                                name="{{product_item.handle}}"
                                id="variant-{{variant_item.id}}"
                              >
                              <label class="form-check-label" for="variant-{{variant_item.id}}">
                                <div class="fw-bold">{{ product_item.title }}</div>
                                {% assign handle = product_item.handle %}
                                <div class="fst-italic fs-6 text-secondary lh-1">
                                  {{ all_products[handle].metafields.global.description_tag }}
                                </div>
                              </label>
                            </div>
                          </div>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            <div class="buttons button_space mt-4">
              <button class="back_button">
                <div>&lt;&nbsp;</div>
                {% if is_colour_or_finish > 0 %}
                  <div>Colour & Finish</div>
                {% else %}
                  <div>Product Information</div>
                {% endif %}
              </button>
              {% if page_num > 1 %}
                <button class="next_button">
                  <div>Additional Products</div>
                  <div>&nbsp;&gt;</div>
                </button>
              {% else %}
                <button class="next_button">
                  <div>Bundle Review</div>
                  <div>&nbsp;&gt;</div>
                </button>
              {% endif %}
            </div>
          </div>
          {% if page_num > 1 %}
            <div class="main">
              <div class="">
                <div class="mt-1 pb-3"><h3 class="h-label small">Additional Products</h3></div>
                {% for product_handle in product_handle_list %}
                  {% assign loop_index = forloop.index | minus: 1 %}
                  {% if loop_index >= first_page_products %}
                    {% assign product_item = all_products[product_handle] %}
                    <div class="fw-bold">{{ product_item.title }}</div>
                    <div class="row mb-2">
                      {% assign qty = product_qty_list[loop_index] | plus: 0 %}
                      {% if qty > 1 %}
                        <div class="">
                          <div class="form-check">
                            <input
                              class="form-check-input p-2"
                              type="checkbox"
                              checked
                              value="{{product_item.id}}"
                              name="{{product_item.handle}}"
                              id="product-{{product_item.id}}"
                            >
                            <label class="form-check-label" for="product-{{product_item.id}}">
                              <div class="fw-bold">{{ product_item.title }}</div>
                              {% assign handle = product_item.handle %}
                              <div class="fst-italic fs-6 text-secondary lh-1">
                                {{ all_products[handle].metafields.global.description_tag }}
                              </div>
                              <select
                                class="form-select mt-1 product-{{product_item.id}}"
                                aria-label="Default select example"
                              >
                                <option selected>Select</option>
                                {% for variant_item in product_item.variants %}
                                  {% if variants_str contains variant_item.id %}
                                    <option value="{{variant_item.id}}">{{ variant_item.title }}</option>
                                  {% endif %}
                                {% endfor %}
                              </select>
                            </label>
                          </div>
                        </div>
                      {% else %}
                        {% for variant_item in product_item.variants %}
                          {% if variants_str contains variant_item.id %}
                            <div class="">
                              <div class="form-check">
                                <input
                                  class="form-check-input p-2"
                                  type="checkbox"
                                  checked
                                  value="{{variant_item.id}}"
                                  name="{{product_item.handle}}"
                                  id="variant-{{variant_item.id}}"
                                >
                                <label class="form-check-label" for="variant-{{variant_item.id}}">
                                  <div class="fw-bold">{{ product_item.title }}</div>
                                  {% assign handle = product_item.handle %}
                                  <div class="fst-italic fs-6 text-secondary lh-1">
                                    {{ all_products[handle].metafields.global.description_tag }}
                                  </div>
                                </label>
                              </div>
                            </div>
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
              <div class="buttons button_space mt-4">
                <button class="back_button">
                  <div>&lt;&nbsp;</div>
                  <div>Included Products</div>
                </button>
                <button class="next_button">
                  <div>Bundle Review</div>
                  <div>&nbsp;&gt;</div>
                </button>
              </div>
            </div>
          {% endif %}
        {% endif %}

        <div class="main">
          <div class="selected-variants"></div>
          <div class="buttons button_space">
            {% if page_num > 1 %}
              <button class="back_button">
                <div>&lt;&nbsp;</div>
                <div>Additional Products</div>
              </button>
            {% else %}
              <button class="back_button">
                <div>&lt;&nbsp;</div>
                <div>Included Products</div>
              </button>
            {% endif %}
            <button class="submit_button"><div>Add To Cart</div></button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .form_container {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .form_container .card {
    width: 100%;
  }

  .form .left-side {
    box-sizing: border-box;
  }
  .left-side .description {
    font-size: 13px;
  }
  .form-progress-bar {
    list-style: none;
    margin-top: 20px;
    font-size: 13px;
    font-weight: 700;
    counter-reset: container 0;
  }
  .form-progress-bar li {
    position: relative;
    margin-left: 40px;
    margin-top: 40px;
    counter-increment: container 1;
    color: #4f6581;
  }
  .form-progress-bar li p {
    opacity: 0.35;
    font-size: 14px !important;
  }
  .form-progress-bar li::before {
    content: counter(container);
    line-height: 25px;
    text-align: center;
    position: absolute;
    height: 25px;
    width: 25px;
    border: 1px solid #d5d5d5;
    border-radius: 50%;
    left: -40px;
    z-index: 10;
    background-color: #ffffff;
    box-sizing: content-box;
  }

  .form-progress-bar li::after {
    content: '';
    position: absolute;
    height: 90px;
    width: 2px;
    background-color: #f7f7f7;
    z-index: 1;
    left: -27px;
    top: -65px;
  }

  .form-progress-bar li.active p {
    opacity: 1 !important;
    font-weight: bold !important;
  }

  .form-progress-bar li.active::after {
    background-color: #cccccc;
  }

  .form-progress-bar li:first-child:after {
    display: none;
  }

  .form-progress-bar li.active::before {
    border: 1px solid #bbbbbb;
  }
  .form-progress-bar li.active {
  }

  /*left-side-end*/
  .form_container .card .right-side {
    background-color: #fff;
  }
  /*right-side-start*/
  .company-form {
    display: none;
  }
  .active {
    display: block !important;
  }
  .main {
    display: none;
    padding: 48px 40px;
    height: 100%;
    position: relative;
  }
  .main > div:first-child {
    min-height: 80%;
  }
  select:invalid {
    color: #999;
  }
  option {
    color: black;
  }
  .input-div input:focus ~ span,
  .input-div input:valid ~ span {
    top: -15px;
    left: 6px;
    font-size: 10px;
    font-weight: 600;
  }

  .input-div span {
    top: -15px;
    left: 6px;
    font-size: 10px;
  }
  .buttons button,
  div.button_space button.next_button {
    border: none;
    border-radius: 5px;
    background-color: #0075ff;
    font-size: 14px;
    color: #fff;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 5px 20px;
    line-height: 1.5;
  }
  .button_space {
    display: flex;
    gap: 20px;
    margin-top: 20px;
  }
  .button_inline {
    display: flex;
    gap: 20px;
  }
  .button_inline button {
    background-color: #213d81;
    width: 125px;
  }
  .button_inline button.secondary {
    background-color: #0075ff;
    width: 125px;
  }
  .button_space button:nth-child(1) {
    background-color: #fff;
    color: #000;
    border: 1px solid#000;
  }
  button.confirm_company {
    width: 220px;
  }
  button.inactive {
    background-color: #ccc;
  }

  .form.row {
    margin-left: 0px;
    margin-right: 0px;
  }
  .main div:disabled {
    opacity : 0.8;
  }
  .main input[type='radio']:disabled {
    display : none;
  }

  @keyframes stroke {
    100% {
      stroke-dashoffset: 0;
    }
  }
  @keyframes scale {
    0%,
    100% {
      transform: none;
    }
    50% {
      transform: scale3d(1.1, 1.1, 1);
    }
  }
  @keyframes fill {
    100% {
      box-shadow: inset 0px 0px 0px 30px #7ac142;
    }
  }
  .warning {
    border: 2px solid #ee4466 !important;
  }
  .form-progress-bar-mobile {
    display: none;
    list-style: none;
  }
  .form-progress-bar-mobile li {
    display: list-item;
    list-style-position: inside;
    color: transparent;
    flex: auto;
    margin-right: 15px;
    background-color: white;
    height: 5px;
  }
  .form-progress-bar-mobile li.active {
    background-color: green;
  }
  .custom-control-input {
    position: absolute;
    top: 2px;
    left: 3px;
    z-index: -1;
    opacity: 0;
    padding: 0px;
  }
  .custom-control-input:checked {
    z-index: 1;
    opacity: 1;
  }
  .unit-font {
    font-size: 13px;
  }

  /*right-side-end*/
  @media (max-width: 768px) {
    .main {
      padding: 20px;
    }
    .form_container {
      height: scroll;
    }
    .form_container .card {
      max-width: 350px;
      height: auto !important;
      margin: 30px 0;
    }
    .form_container .card .right-side {
      width: 100%;
    }
    .form-progress-bar {
      display: none;
    }
    .form-progress-bar-mobile {
      display: flex;
    }
  }
</style>
<script>
  var variants = [];
  var obj = {};
  {% for product_item in products %}
    {% for variant_item in product_item.variants %}
      obj = {{variant_item | json}};
      obj.metafields = {};
      obj.metafields.yield_for_variant = {};
      {% if product_item.metafields.custom.yield != blank %}
        {% if product_item.metafields.custom.yield.value.gallon_per_package != blank %}
          obj.metafields.yield_for_variant.gallon_per_package = {{ product_item.metafields.custom.yield.value.gallon_per_package.value }}
        {% endif %}
        {% if product_item.metafields.custom.yield.value.sqf_per_gallon != blank %}
          obj.metafields.yield_for_variant.sqf_per_gallon = {{ product_item.metafields.custom.yield.value.sqf_per_gallon.value }}
        {% endif %}
        {% if product_item.metafields.custom.yield.value.modify_percentage != blank %}
          obj.metafields.yield_for_variant.modify_percentage = {{ product_item.metafields.custom.yield.value.modify_percentage.value }}
        {% endif %}
      {% endif %}
      {% if variant_item.metafields.custom.yield_for_variant != blank %}
        obj.metafields.yield_for_variant = {};
        {% if variant_item.metafields.custom.yield_for_variant.value.gallon_per_package != blank %}
          obj.metafields.yield_for_variant.gallon_per_package = {{ variant_item.metafields.custom.yield_for_variant.value.gallon_per_package.value }}
        {% endif %}
        {% if variant_item.metafields.custom.yield_for_variant.value.sqf_per_gallon != blank %}
          obj.metafields.yield_for_variant.sqf_per_gallon = {{ variant_item.metafields.custom.yield_for_variant.value.sqf_per_gallon.value }}
        {% endif %}
        {% if variant_item.metafields.custom.yield_for_variant.value.modify_percentage != blank %}
          obj.metafields.yield_for_variant.modify_percentage = {{ variant_item.metafields.custom.yield_for_variant.value.modify_percentage.value }}
        {% endif %}
      {% endif %}
      obj.product = {{ variant_item.product | json}}
      variants.push(obj);
    {% endfor %}
  {% endfor %}
  {% for variant_item in variants %}
    obj = {{variant_item | json}};
    obj.metafields = {};
    obj.metafields.yield_for_variant = {};
    {% if variant_item.product.metafields.custom.yield != blank %}
      {% if variant_item.product.metafields.custom.yield.value.gallon_per_package != blank %}
        obj.metafields.yield_for_variant.gallon_per_package = {{ variant_item.product.metafields.custom.yield.value.gallon_per_package.value }}
      {% endif %}
      {% if variant_item.product.metafields.custom.yield.value.sqf_per_gallon != blank %}
        obj.metafields.yield_for_variant.sqf_per_gallon = {{ variant_item.product.metafields.custom.yield.value.sqf_per_gallon.value }}
      {% endif %}
      {% if variant_item.product.metafields.custom.yield.value.modify_percentage != blank %}
        obj.metafields.yield_for_variant.modify_percentage = {{ variant_item.product.metafields.custom.yield.value.modify_percentage.value }}
      {% endif %}
    {% endif %}
    {% if variant_item.metafields.custom.yield_for_variant != blank %}
      obj.metafields.yield_for_variant = {};
      {% if variant_item.metafields.custom.yield_for_variant.value.gallon_per_package != blank %}
        obj.metafields.yield_for_variant.gallon_per_package = {{ variant_item.metafields.custom.yield_for_variant.value.gallon_per_package.value }}
      {% endif %}
      {% if variant_item.metafields.custom.yield_for_variant.value.sqf_per_gallon != blank %}
        obj.metafields.yield_for_variant.sqf_per_gallon = {{ variant_item.metafields.custom.yield_for_variant.value.sqf_per_gallon.value }}
      {% endif %}
      {% if variant_item.metafields.custom.yield_for_variant.value.modify_percentage != blank %}
        obj.metafields.yield_for_variant.modify_percentage = {{ variant_item.metafields.custom.yield_for_variant.value.modify_percentage.value }}
      {% endif %}
    {% endif %}
    obj.product = {{ variant_item.product | json}}
    variants.push(obj);
  {% endfor %}
</script>
<script>
  
  
  
    
  
  var next_click = document.querySelectorAll('.next_button');
  var main_form = document.querySelectorAll('.main');
  var step_list = document.querySelectorAll('.form-progress-bar li');
  var step_list_mobile = document.querySelectorAll('.form-progress-bar-mobile li');
  var company_form = document.querySelectorAll('.company-form');
  let formnumber = 0;

  next_click.forEach(function (next_click_form) {
    next_click_form.addEventListener('click', function () {
      formnumber++;
      updateform();
      progress_forward();
    });
  });

  let checkboxes = document.querySelectorAll('input[type="checkbox"]');
  for (i = 0; i < checkboxes.length; i++) {
    let elem = checkboxes[i];
    let id = elem.id;
    let select = document.querySelector(`.${id}`);
    if (!!select) {
      elem.addEventListener('change', function() {
        if (this.checked) {
          document.querySelector(`.${id}`).disabled = false; //for select box
          let radios = document.querySelectorAll(`.${id} [type="radio"]`); //for radio
          for (j = 0; j < radios.length; j++) {
            radios[j].disabled = false;
          }
        } else  {
          document.querySelector(`.${id}`).disabled = true; //for select box
          let radios = document.querySelectorAll(`.${id} [type="radio"]`);  //for radio
          for (j = 0; j < radios.length; j++) { 
            radios[j].disabled = true;
          }
        } 
      })
    }
  }

{% comment %} insert selected variants to bundle review step {% endcomment %}
  let last_next_click = document.querySelector('.main:nth-last-of-type(2) .next_button');
  last_next_click.addEventListener('click', () => {
    let project_area = document.getElementById('project_area').value;
    let elems = document.querySelectorAll('.form_container input[type="radio"]:checked:not([disabled]), .form_container input[type="checkbox"]:checked, .form_container select:not([disabled])');
    let elems_str = '<div class="mt-1 pb-3"><h3 class="h-label small">Bundle Review</h3></div>';
    let elems_str1 = '';  //for non products
    let total_price = 0;
    let discount = 0, sub_total = 0;    
    {% if product.metafields.custom.extend_bundle != blank %}
      {% assign bundle_discount = 0 %}
      {% assign extend_bundles = product.metafields.custom.extend_bundle.value %}
      {% for extend_bundle in extend_bundles %}
        {% assign bundle_discount = extend_bundle.bundle_discount.value %}
      {% endfor %}
      discount = {{ bundle_discount }}
    {% endif %}
    for (i = 0; i < elems.length ; i++) {
      let variant_id = elems[i].value;
      let variant = variants.find((v) => v.id == variant_id);
      if (!!variant) {
        let img_url = variant.product.featured_image;
        if (!!variant.featured_image) img_url = variant.featured_image.src;
        let variant_title  = variant.title.replace('Default Title', '');
        if (Object.keys(variant.metafields.yield_for_variant).length > 0) {
          let gallon_per_package = variant.metafields.yield_for_variant.gallon_per_package
          let sqf_per_gallon = variant.metafields.yield_for_variant.sqf_per_gallon
          let qty = (project_area / (gallon_per_package * sqf_per_gallon)).toFixed(2);
          let qty_ceil = Math.ceil(qty);
          let sub_price = qty_ceil * variant.price / 100;
          elems_str += `
          <div class='d-flex justify-content-between mb-2'>
            <div class='col-9 col-sm-9 col-md-8'>
              <div class='row'>
                <div class='col-9'>
                  <span class=' fw-bold lh-sm'>${variant.product.title}${variant_title.length > 0 ? ": " : " "}</span>
                  <span>${variant_title}</span>
                </div>
                <div class='col-3 text-end px-0'>(${qty_ceil})</div>
              </div>
              <div class='fst-italic'>
                <span class='unit-font'>${sqf_per_gallon} sqf per gal; </span>
                <span class='unit-font'>${gallon_per_package} gal per unit </span>
              </div>
            </div>
            <div class=''>
              <div class=' fw-bold lh-sm text-end'>${sub_price.toLocaleString("en-US", {style: "currency", currency: "USD"})}</div>
              <div class='fst-italic unit-font text-end'>${(variant.price /100).toLocaleString("en-US", {style: "currency", currency: "USD"})}</div>
            </div>
          </div>
            ` 
            total_price += sub_price;
        } else {
          elems_str1 += `
          <div class='d-flex justify-content-between mb-2'>
            <div class=''>
              <div class='col-12'>
                <span class=' fw-bold lh-sm'>${variant.product.title}${variant_title.length > 0 ? ": " : " "}</span>
                <span>${variant_title}</span>
              </div>
            </div>
          </div>
            ` 
        }
      }
    }
    elems_str += elems_str1;
    sub_total = total_price * (100 - discount) / 100
    elems_str += `
      <hr />
      <div class='mt-4 fw-bold lh-sm text-end'>
        <span class='${discount > 0 ? '' : 'd-none'}'>
          <span class='text-dark'>(</span>
          <span class='text-decoration-line-through text-danger'>${(total_price).toLocaleString("en-US", {style: "currency", currency: "USD"})}</span>
          <span class='text-dark'>) </span>
        </span>  
        ${(sub_total).toLocaleString("en-US", {style: "currency", currency: "USD"})}
      </div>    
      <div class='d-flex flex-row-reverse '>
        <div class='col-sm-6 fst-italic unit-font text-end'>
          Subtotal (any applicable taxes and shipping costs will be shown  during the checkout process.)
        </div>
      </div>
    `;
    console.log('variants', variants)
    document.querySelector('.selected-variants').innerHTML = elems_str;
    document.querySelector('.form_container .price').innerHTML = `${sub_total.toLocaleString("en-US", {style: "currency", currency: "USD"})}`;
  })

  var back_click = document.querySelectorAll('.back_button');
  back_click.forEach(function (back_click_form) {
    back_click_form.addEventListener('click', function () {
      formnumber--;
      updateform();
      progress_backward();
    });
  });


  var submit_click = document.querySelectorAll('.submit_button');
  submit_click.forEach(function (submit_click_form) {
  });

  function updateform() {
    main_form.forEach(function (mainform_number) {
      mainform_number.classList.remove('active');
    });
    main_form[formnumber].classList.add('active');
  }

  function progress_forward() {
    step_list[formnumber].classList.add('active');
    step_list_mobile[formnumber].classList.add('active');
  }

  function progress_backward() {
    var form_num = formnumber + 1;
    step_list[form_num].classList.remove('active');
    step_list_mobile[form_num].classList.remove('active');
  }

  /***********   first step of form ************/
  let qty_to_area = 2500;
  function convertQtyToArea(e) {
    let product_quantity = document.querySelector('#product_quantity').value;
    console.log(e.type, product_quantity)
    if (!!product_quantity) {
      document.querySelector('#project_area').value = product_quantity * qty_to_area;
    } else {
      document.querySelector('#project_area').value = '';
    }
  }
  {% comment %} document.querySelector('#product_quantity').addEventListener('change', convertQtyToArea); {% endcomment %}
  document.querySelector('#product_quantity').addEventListener('input', convertQtyToArea);

  function convertAreaToQty(e) {
    let project_area = document.getElementById('project_area').value;
    let elems = document.querySelectorAll('.form_container input[type="radio"]:checked, .form_container input[type="checkbox"]:checked, .form_container select:not([disabled])');
    let total_price = 0;
    let discount = 0, sub_total = 0;    
    {% if product.metafields.custom.extend_bundle != blank %}
      {% assign bundle_discount = 0 %}
      {% assign extend_bundles = product.metafields.custom.extend_bundle.value %}
      {% for extend_bundle in extend_bundles %}
        {% assign bundle_discount = extend_bundle.bundle_discount.value %}
      {% endfor %}
      discount = {{ bundle_discount }}
    {% endif %}
    for (i = 0; i < elems.length ; i++) {
      let variant_id = elems[i].value;
      let variant = variants.find((v) => v.id == variant_id);
      if (!!variant) {
        let img_url = variant.product.featured_image;
        if (!!variant.featured_image) img_url = variant.featured_image.src;
        if (Object.keys(variant.metafields.yield_for_variant).length > 0) {
          let gallon_per_package = variant.metafields.yield_for_variant.gallon_per_package
          let sqf_per_gallon = variant.metafields.yield_for_variant.sqf_per_gallon
          let qty = (project_area / (gallon_per_package * sqf_per_gallon)).toFixed(2);
          let qty_ceil = Math.ceil(qty);
          let sub_price = qty_ceil * variant.price / 100;
          total_price += sub_price;
        } 
      }
    }
    sub_total = total_price * (100 - discount) / 100
    document.querySelector('.form_container .price').innerHTML = `${sub_total.toLocaleString("en-US", {style: "currency", currency: "USD"})}`;
  }
  {% comment %} document.querySelector('#project_area').addEventListener('change', convertAreaToQty); {% endcomment %}
  document.querySelector('#project_area').addEventListener('input', convertAreaToQty);
  setTimeout(() => {
    document.querySelector('#project_area').dispatchEvent(new InputEvent("input"));
    let elems = document.querySelectorAll('.form_container input[type="radio"]:checked, .form_container input[type="checkbox"]:checked, .form_container select:not([disabled])');
    for (i = 0; i < elems.length; i++) {
      let elem = elems[i];
      elem.addEventListener('change', convertAreaToQty);
    }
  }, 100)

















</script>
